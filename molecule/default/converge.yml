# vim: set ft=yaml ts=2 expandtab:
---

- name: Set up proxy
  hosts: proxy_group

  pre_tasks:

  # https://github.com/geerlingguy/ansible-role-composer/issues/54
  #
  - name: get status of systemd-tmpfiles-setup.service # noqa 303
    command: systemctl status systemd-tmpfiles-setup.service
    when: ansible_service_mgr == 'systemd'
    changed_when: false

  roles:
  - name: mafalb.squid.server

  tasks:

  # use the proxy as client for verify steps
  #
  - name: openssh clients are present
    package:
      name: openssh-clients

  - name: ssh key is present
    openssh_keypair:
      path: /tmp/id_rsa
      type: rsa

- name: Converge
  hosts: all,!infrastructure_group
  roles:
  - role: mafalb.openssh.sshd

  tasks:

  - name: get public key
    delegate_to: ci_proxy
    command: cat /tmp/id_rsa.pub
    changed_when: false
    register: _public_key
    run_once: true

  - block:

    - name: user is present
      user:
        name: "{{ item }}"
      loop:
      - testssh1
      - testssh2

    - name: authorized_keys is present
      authorized_key:
        user: "{{ item }}"
        key: "{{ _public_key.stdout }}"
      loop:
      - testssh1
      - testssh2

...
